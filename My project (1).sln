using System;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;
using Random=System.Random;

public class Player : MonoBehaviour
{
#region Inputs    
    [SerializeField] private Rigidbody2D rb;
    [SerializeField] private Animator player;
    [SerializeField] private Vector2 lastPosition;
    [SerializeField] public Text Texts;
    [SerializeField] public Text Timer;
    [SerializeField] public Text Result;
    [SerializeField] private float speed = 4;
    [SerializeField] private float jumpForce = 5f;
    [SerializeField] private bool player1; 
    private Vector2 FBall; 
    private GameObject panel;
    private GameObject ball;
    private bool onGround=true;
    private bool RegisteredGoal=false;
    private bool modifyRange=false;
    private bool GameOver=false;
    public static bool NormalMode=false;
    private int player1C=0;
    private int player2C=0;
    private int Rescale;
    private int modCharacter;
    private float currentTime;
    private float startingTime=60f;
    
#endregion

#region PlayerCollision
     void OnCollisionEnter2D(Collision2D col) 
    {
        if (col.gameObject.tag=="Teren") onGround=true; 
    }

    private  void OnCollisionExit2D(Collision2D col2)
    {
        if (col2.gameObject.tag=="Teren") onGround=false;
    }
#endregion
  
private void UpdateScore()
{
    #region ScoreUpdating
         Texts.text = player1C.ToString()+" : "+player2C.ToString();  
         if ((modifyRange==false) && (Rescale==(player1C+player2C)))
         {
            modifyRange=true;
            Random rd=new Random();
            modCharacter=rd.Next(1,3);
         }  
        else if(Rescale!=(player1C+player2C)) 
        {
            modifyRange=false;
            modCharacter=0;
        }
    #endregion
}
private void Reset() 
{
    Vector2 reset, reset2;
    reset=new Vector2(-7.8f,0.6f);
    reset2=new Vector2(7.8f,0.6f);
    if (rb.name=="Ghost1") rb.position= reset;
    if (rb.name=="Ghost2") 
    {
        rb.position= reset2;
        rb.transform.localScale=new Vector2(-0.4f,0.4f);
    }
    ball=GameObject.Find("Ball");
    ball.GetComponent<Rigidbody2D>().velocity=Vector2.zero;
    ball.GetComponent<Rigidbody2D>().angularVelocity = 0; 
    ball.transform.position=new Vector2(0,-0.2f);    
}


    #region Init  
    void Start()
    {
        panel=GameObject.Find("Canvas/LevelPanel");
        if(!NormalMode)
        {
            Random rd=new Random();
            Rescale=rd.Next(1,4);
            Debug.Log("Score: "+Rescale);
        }
        else Rescale=-1;
        rb = GetComponent<Rigidbody2D>();
        if(transform.name=="Ghost1")
            player1=true;
            else
            player1=false; 
        UpdateScore();
        currentTime=startingTime;
    }
#endregion
    private void FixedUpdate() 
    {
        if (!GameOver) panel.SetActive(false);
    #region global
            
        if (Input.GetAxisRaw("Vertical")==0)
        {   
            player.SetFloat("Movement",Vector2.Distance((Vector2)transform.position,lastPosition)/Time.fixedDeltaTime);
            lastPosition=transform.position;
        }
#endregion

    #region TimeCounter
        currentTime -= 1 * Time.fixedDeltaTime; 
        Timer.text=((int)currentTime+ " seconds");
        if (currentTime<1 && (player1C==player2C)) Timer.text=("golden goal");
        if(currentTime<1 && player1C>player2C && !GameOver) 
        {
            Result.text=("Winner: Ghost1");
            currentTime=10;
            GameOver=true;
            panel.SetActive(true);
        }
        else if (currentTime<1 && player1C<player2C && !GameOver) 
        {
            Result.text=("Winner Ghost2");
            currentTime=10;
            GameOver=true;
            panel.SetActive(true);
        }
        if (GameOver==true && currentTime<1)
        {
            Result.text="";
            Reset();
            player1C=0;
            player2C=0;
            UpdateScore();
            GameOver=false;
            currentTime=60;
        }
        #endregion

        
    #region GoalChecking
        if (FBall.x<(-9.2f) || FBall.x>9.2f)
        {
            RegisteredGoal=false;
            if (!RegisteredGoal)
            {
                if (FBall.x<(-9.2f) && FBall.y<1.21f) player2C=player2C+1;
                if (FBall.x>9.2f && FBall.y<1.21f ) player1C=player1C+1;
                Reset();
                RegisteredGoal=true;
                Debug.Log("Player1: " + player1C + " || Player2: " + player2C);
                UpdateScore();
            }
        }
#endregion

    }

    private void Update()
    {

    #region Ball_Position        
         FBall=(Vector2)GameObject.Find("Ball").transform.position;
#endregion

    #region Player1Input
        if (player1)
        {
            if (Input.GetKey(KeyCode.S)) player.SetBool("SpacePressed",true);
            else player.SetBool("SpacePressed",false);
            if ((Input.GetKeyDown(KeyCode.W)) && onGround==true)
            {
                rb.AddForce((Vector2.up*jumpForce*Time.fixedDeltaTime),ForceMode2D.Force);
            }
            if (Input.GetKey(KeyCode.A))
            {
                rb.velocity=transform.right*-1*speed;
                //playerScale
                if (modifyRange && modCharacter==1) transform.localScale=new Vector2(-0.1f,0.1f);
                else transform.localScale=new Vector2(-0.4f,0.4f);
                //
            }
            else if(Input.GetKey(KeyCode.D))
            {
                rb.velocity=transform.right*speed;
                //playerScale
                if(modifyRange && modCharacter==1) transform.localScale=new Vector2(0.1f,0.1f);
                else transform.localScale=new Vector2(0.4f,0.4f);
                //
            }
        }   
#endregion

    #region Player2Input
    if (!player1)
    {
        if (Input.GetKey(KeyCode.DownArrow)) player.SetBool("spacePressed2",true);
        else player.SetBool("spacePressed2",false);
        if ((Input.GetKeyDown(KeyCode.UpArrow)) && onGround==true)
        {
            rb.AddForce(Vector2.up*jumpForce*Time.fixedDeltaTime,ForceMode2D.Force);
        }
        if (Input.GetKey(KeyCode.LeftArrow))
        {
            rb.velocity=transform.right*-1*speed;
            //playerScale
            if (modifyRange && modCharacter==2) transform.localScale=new Vector2(-0.1f,0.1f);
            else transform.localScale=new Vector2(-0.4f,0.4f);
            //
        }
        else if(Input.GetKey(KeyCode.RightArrow))
        {
            rb.velocity=transform.right*speed;
            //playerScale
            if(modifyRange && modCharacter==2) transform.localScale=new Vector2(0.1f,0.1f);
            else transform.localScale=new Vector2(0.4f,0.4f);
            //
        }
        
    }
#endregion    
    }
}
